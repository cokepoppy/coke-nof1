# 实时行情配置指南

## 功能概述

系统已集成 CoinGecko API，可实时拉取并显示以下加密货币的行情数据：
- BTC (Bitcoin)
- ETH (Ethereum)
- SOL (Solana)
- BNB (Binance Coin)
- DOGE (Dogecoin)
- XRP (Ripple)

## 技术实现

### 后端
1. **CoinGeckoService** (`backend/src/services/coinGeckoService.ts`)
   - 使用 CoinGecko 公开 API（无需 API 密钥）
   - 通过 REST API 轮询获取价格更新
   - 每 10 秒更新一次（CoinGecko 免费限制）
   - 包含价格、24 小时涨跌幅、24 小时成交量

2. **WebSocket Server** (`backend/src/websocket/index.ts`)
   - 使用 Socket.IO 推送实时价格给前端
   - 支持订阅/取消订阅机制
   - 连接时立即发送当前价格

### 前端
1. **useWebSocket Hook** (`frontend/src/hooks/useWebSocket.ts`)
   - 管理 WebSocket 连接
   - 自动订阅价格更新
   - 将数据更新到 Redux store

2. **Market Slice** (`frontend/src/store/slices/marketSlice.ts`)
   - 存储实时价格数据
   - 支持单个/批量价格更新

3. **Live Page** (`frontend/src/pages/Live.tsx`)
   - 显示实时价格
   - 显示 24 小时涨跌幅
   - 绿色表示上涨，红色表示下跌

## 配置步骤

### 1. 无需 API 密钥

**好消息**：CoinGecko 公开 API 无需任何 API 密钥！开箱即用。

### 2. 配置环境变量

编辑 `.env` 文件（如果不存在，从 `.env.example` 复制）：

```bash
# 前端 WebSocket 连接
VITE_SOCKET_URL=http://localhost:3000
```

**注意**：使用 CoinGecko 不需要任何额外的 API 配置。

### 3. 启动服务

#### 使用 Docker Compose（推荐）

```bash
docker-compose up -d
```

#### 手动启动

后端：
```bash
cd backend
npm install
npm run dev
```

前端：
```bash
cd frontend
npm install
npm run dev
```

### 4. 访问应用

打开浏览器访问: http://localhost:5173

实时价格将自动显示在页面顶部的状态栏中。

## 数据更新机制

1. **轮询更新**
   - 每 10 秒从 CoinGecko API 获取最新价格
   - 通过 WebSocket 推送到前端
   - 延迟约 10-12 秒

2. **实时推送**
   - 价格变化时通过 Socket.IO 即时推送到前端
   - 多个客户端同时接收更新
   - 包括价格、24小时涨跌幅、成交量

3. **自动重连**
   - API 请求失败自动重试
   - 初始化失败 10 秒后重试
   - WebSocket 连接断开自动重连

## 故障排查

### 问题：无法连接到 CoinGecko API

**可能原因**：
- 网络连接问题
- 超过 API 速率限制（免费版：50次/分钟）
- CoinGecko 服务暂时不可用

**解决方案**：
1. 检查网络连接是否正常
2. 查看后端日志：`docker-compose logs backend` 或查看控制台输出
3. 等待 10 秒后服务会自动重试
4. 如果频繁超限，考虑增加轮询间隔（修改 `coinGeckoService.ts` 中的 10000ms）

### 问题：前端显示"Loading real-time prices..."

**可能原因**：
- WebSocket 未连接
- 后端服务未启动

**解决方案**：
1. 检查后端服务是否运行
2. 打开浏览器开发者工具查看 WebSocket 连接状态
3. 检查 `VITE_SOCKET_URL` 环境变量配置

### 问题：价格不更新

**可能原因**：
- WebSocket 连接断开
- Binance WebSocket 连接失败

**解决方案**：
1. 刷新页面重新连接
2. 查看后端日志检查 Binance WebSocket 状态
3. 重启后端服务

## API 使用限制

CoinGecko 免费 API 限制：
- **REST API**：50 次调用/分钟
- **当前配置**：6 次/分钟（每 10 秒 1 次）
- **无需API密钥**：公开数据可自由访问
- **数据延迟**：通常实时，但在高流量时可能有几秒延迟

### 升级选项

如需更高频率更新或更多功能，可考虑：
1. **CoinGecko Pro**：500 次/分钟，更多数据点
2. **自建价格聚合**：从多个交易所聚合数据

## 安全建议

1. **速率限制**
   - 遵守 CoinGecko API 使用限制
   - 避免频繁请求
   - 使用缓存减少重复请求

2. **错误处理**
   - 实现重试机制
   - 监控 429 错误（速率限制）
   - 添加备用数据源

3. **监控**
   - 监控 API 响应时间
   - 跟踪失败率
   - 设置告警阈值

## 扩展功能

### 添加新的加密货币

编辑 `backend/src/services/coinGeckoService.ts`：

```typescript
private coinIds: { [key: string]: string } = {
  'BTC': 'bitcoin',
  'ETH': 'ethereum',
  'SOL': 'solana',
  'BNB': 'binancecoin',
  'DOGE': 'dogecoin',
  'XRP': 'ripple',
  'ADA': 'cardano',      // 新增 Cardano
  'AVAX': 'avalanche-2',  // 新增 Avalanche
};
```

**注意**：需要使用 CoinGecko 的 coin ID，可在 [CoinGecko 网站](https://www.coingecko.com/) 查询。

### 修改更新频率

编辑 `backend/src/services/coinGeckoService.ts`：

```typescript
// 修改轮询间隔（毫秒）
// 注意：CoinGecko 免费版限制 50次/分钟
this.pollInterval = setInterval(() => {
  this.fetchPrices();
}, 15000); // 改为 15 秒（4次/分钟）
```

## 性能优化

1. **减少 WebSocket 消息**
   - 仅订阅需要的交易对
   - 使用批量更新而非单个更新

2. **缓存策略**
   - 前端使用 Redux 缓存价格数据
   - 后端使用 Map 缓存最新价格

3. **连接池管理**
   - 单个 WebSocket 连接订阅多个交易对
   - 避免创建多个连接

## 相关文档

- [CoinGecko API 文档](https://www.coingecko.com/en/api/documentation)
- [Socket.IO 文档](https://socket.io/docs/v4/)
- [Redux Toolkit 文档](https://redux-toolkit.js.org/)
- [Axios 文档](https://axios-http.com/docs/intro)
